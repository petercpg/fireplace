{% include '_macros/market_tile.html' %}
{% from "_macros/market_button.html" import market_button %}

{% macro mini_tile(app) %}
  <a href="{{ url('app', [app.slug])|urlparams(src=src) }}" class="c">
    <img src="{{ app.icons[64] }}" alt="{{ app.name|translate(app) }}">
    <div class="info">
      <h2>{{ app.name|translate(app) }}</h2>
      <p class="author lineclamp">{{ app.author }}</p>
      <div class="rating vital{{ ' unrated' if not app.ratings.count }}" itemprop="aggregateRating" itemscope itemtype="http://schema.org/AggregateRating">
        {{ stars(app.ratings.average) }}
      </div>
    </div>
    {{ market_button(app, classes=(['paid'] if app.payment_required),
                     data_attrs={'manifest_url': app.manifest_url,
                                 'slug': app.slug}) if app.slug }}
  </a>
{% endmacro %}

{% macro feed_brand(feed_item) %}
  {% set brand = feed_item.brand %}

  <section class="feedbrand feed-{{ brand.layout }} mkt-tile c">
    {# TODO: `src` based on the brand `brand.type`. Nuke inline style. #}
    <img src="" class="brand" style="background-color: green">
    <div class="info">
      <h1>{{ feed.get_brand_name(brand) }}</h1>
    </div>
    <ul class="app-list">
      {% for app in brand.apps %}
        <li>{{ mini_tile(app) }}</li>
      {% endfor %}
    </ul>
  </section>
{% endmacro %}

{% macro feed_collection(feed_item) %}
  {% set coll = feed_item.collection %}
  {% set color = coll.background_color %}
  {% set shelf = True if coll.type == 'shelf' else False %}

  <a href="{{ obj.resource_url }}" class="fanchor">
    <section class="feeditem{{ ' shelf' if shelf }}
                    {{ 'mega' if coll.description and not shelf }}
                    {{ 'full' if not shelf }}"
                    {% if not coll.description or not coll.background_image %}
                      style="background-color: {{ color|hex2rgba('.4') }}"
                    {% elif coll.background_image %}
                      style="background-image: url({{ coll.background_image }})"
                   {% endif %}>
      {% if not shelf %}
        <ul class="app-icons">
          {% for app in coll.apps %}
            <li><img src="{{ app.icons[64] }}" alt="{{ app.name }}"></li>
          {% endfor %}
        </ul>
      {% endif %}
      <div class="curve" style="background-color: {{ color|hex2rgba('.6') }}"></div>
      <div class="info">
        <h1>{{ coll.name }}</h1>
        <p class="author">{{ coll.author }}</p>
      </div>
      {% if not shelf %}
        <div class="alt-curve" style="background-color: {{ color|hex2rgba('.8') }}"></div>
      {% endif %}
      <div class="desc">{{ coll.description }}</div>
    </section>
  </a>
{% endmacro %}

{% macro feed_app(feed_item) %}
  {% set feed_app = feed_item.app %}
  {% set color = feed_app.background_color %}

  <a href="{{ obj.resource_url }}" class="fanchor">
    {% if indexOf([feed.FEEDAPP_ICON, feed.FEEDAPP_IMAGE], feed_app.type) != -1 %}
      <section class="feeditem"
               {% if not item.description or not item.background_image %}
                 style="background-color: {{ color|hex2rgba('.4') }}"
               {% elif item.background_image %}
                 style="background-image: url({{ item.background_image }})"
               {% endif %}>
        {% if feed_app.type == feed.FEEDAPP_ICON %}
          <ul class="app-icons">
            <li><img src="{{ feed_app.app.icons[64] }}" alt="{{ feed_app.app.name }}"></li>
          </ul>
        {% endif %}
        <div class="curve" style="background-color: {{ color|hex2rgba('.6') }}"></div>
        <div class="info">
          <h1>{{ feed_app.app.name }}</h1>
          <p class="author">{{ feed_app.app.author }}</p>
        </div>
        <div class="alt-curve" style="background-color: {{ color|hex2rgba('.8') }}"></div>
      </section>
    {% elif feed_app.type %}
      {{ market_tile(feed_app.app, tray=False, classes=['feed-app'],
                     feed_app=True, feed_extras=feed_app|feed_app_extras) }}
    {% endif %}
  </a>
{% endmacro %}

{% macro feed_item(obj) %}
  {% if obj.item_type == 'app' %}
    {{ feed_app(obj) }}
  {% elif obj.item_type == 'brand' %}
    {{ feed_brand(obj) }}
  {% elif obj.item_type == 'collection' %}
    {{ feed_collection(obj) }}
  {% endif %}
{% endmacro %}
